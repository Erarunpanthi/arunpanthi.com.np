# =============================================
# ARUNPANTHI.COM.NP - HTACCESS CONFIGURATION
# =============================================

# Enable rewrite engine (must be at the top)
RewriteEngine On
RewriteBase /

# =============================================
# 1. SECURITY & REDIRECTS
# =============================================

# Force HTTPS (always first)
RewriteCond %{HTTPS} off [OR]
RewriteCond %{SERVER_PORT} 80
RewriteRule ^(.*)$ https://arunpanthi.com.np/$1 [R=301,L]

# Force NON-WWW (choose ONE option - non-www recommended)
# Remove this section if you prefer WWW
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ALTERNATIVE: Force WWW (remove above section and uncomment below)
# RewriteCond %{HTTP_HOST} !^www\. [NC]
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

# Case-insensitive URLs (redirect /Cal to /cal)
RewriteMap lowercase int:tolower
RewriteCond %{REQUEST_URI} [A-Z]
RewriteRule (.*) ${lowercase:$1} [R=301,L]

# Remove trailing slashes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [R=301,L]

# =============================================
# 2. BROWSER CACHING & PERFORMANCE
# =============================================

# Enable browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Default expiration: 1 month
    ExpiresDefault "access plus 1 month"
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"
    
    # CSS & JavaScript
    ExpiresByType text/css "access plus 6 months"
    ExpiresByType application/javascript "access plus 6 months"
    ExpiresByType application/x-javascript "access plus 6 months"
    ExpiresByType text/javascript "access plus 6 months"
    
    # Fonts
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    
    # Media files
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    ExpiresByType audio/mpeg "access plus 1 year"
    ExpiresByType audio/wav "access plus 1 year"
    
    # Documents
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/xml "access plus 1 hour"
    
    # Dynamic content (no cache or short cache)
    ExpiresByType text/html "access plus 1 hour"
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/atom+xml "access plus 1 hour"
    ExpiresByType application/rss+xml "access plus 1 hour"
</IfModule>

# Cache-Control headers
<IfModule mod_headers.c>
    # Cache static assets for 1 year (with immutable flag)
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|svg|webp|css|js|woff|woff2|ttf|eot|mp4|webm|pdf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Cache HTML for 1 hour
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header always unset X-Powered-By
    Header always unset Server
    
    # Favicon header injection for HTML files
    <FilesMatch "\.(html|htm)$">
        Header add Link '</logo.ico>; rel="icon"; type="image/x-icon"'
    </FilesMatch>
</IfModule>

# Gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/woff
    AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# =============================================
# 3. FILE PROTECTION & SECURITY
# =============================================

# Protect sensitive files
<FilesMatch "^(\.htaccess|\.htpasswd|wp-config\.php|config\.php|readme\.md|license\.txt|error_log)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect directory from browsing
Options -Indexes

# Prevent clickjacking
Header always append X-Frame-Options SAMEORIGIN

# Block access to hidden files (starting with .)
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# =============================================
# 4. ERROR PAGES
# =============================================

# Custom error pages (create these files in your root directory)
ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html

# =============================================
# 5. SEO & URL OPTIMIZATION
# =============================================

# Remove multiple slashes from URLs
RewriteCond %{THE_REQUEST} //
RewriteRule ^(.*)$ /$1 [R=301,L]

# Redirect index.php to clean URL
RewriteCond %{THE_REQUEST} ^GET.*index\.php [NC]
RewriteRule (.*?)index\.php/*(.*) /$1$2 [R=301,NE,L]

# =============================================
# 6. FILE SPECIFIC RULES
# =============================================

# Prevent hotlinking of images (replace example.com with your domain)
# Uncomment and customize if needed:
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?arunpanthi\.com\.np/.*$ [NC]
# RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,NC]

# Serve WebP images when available
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_ACCEPT} image/webp
    RewriteCond %{DOCUMENT_ROOT}/$1.webp -f
    RewriteRule ^(.*)\.(jpg|jpeg|png)$ $1.webp [T=image/webp,L]
</IfModule>

<IfModule mod_headers.c>
    <FilesMatch "\.webp$">
        Header append Vary Accept
    </FilesMatch>
</IfModule>

# =============================================
# 7. PHP SETTINGS (if using PHP)
# =============================================

<IfModule mod_php.c>
    # Increase PHP memory limit (adjust as needed)
    php_value memory_limit 256M
    
    # Increase max execution time
    php_value max_execution_time 300
    
    # Increase upload limit
    php_value upload_max_filesize 64M
    php_value post_max_size 64M
    
    # Enable error logging (disable in production)
    # php_flag display_errors off
    # php_flag log_errors on
    # php_value error_log /path/to/error_log
</IfModule>

# =============================================
# 8. MIME TYPES
# =============================================

<IfModule mod_mime.c>
    AddType image/webp .webp
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/x-font-woff .woff
    AddType application/font-woff2 .woff2
    AddType image/x-icon .ico
    AddType application/manifest+json .webmanifest
</IfModule>

# =============================================
# FINAL NOTES:
# =============================================

# 1. Test this configuration at: https://htaccess.madewithlove.com/
# 2. Clear browser cache after implementing
# 3. Monitor server logs for any issues
# 4. Back up your original .htaccess file before replacing
# 5. For WordPress sites, some rules may need adjustment
